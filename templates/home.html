{% extends 'layout.html' %}
{% block content %}
  <div class="d-flex justify-content-between mb-2">
    <h3>Home â€” Password Manager</h3>
    <div>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">Lock</a>
      <a href="{{ url_for('export') }}" class="btn btn-outline-success">Export CSV</a>
    </div>
  </div>

  <p>Welcome, {{ session.get('username') }}. Use the form below to add credentials.</p>

  <form method="post" action="{{ url_for('add') }}" class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-4"><input class="form-control" name="service" placeholder="Service"></div>
      <div class="col-md-3"><input class="form-control" name="username" placeholder="Username"></div>
      <div class="col-md-3"><input class="form-control" name="password" placeholder="Password"></div>
      <div class="col-md-2"><button class="btn btn-primary w-100" type="submit">Add</button></div>
    </div>
  </form>

  <div class="list-group tiles-grid">
    {% for e in entries %}
      <div class="list-group-item">
        <div class="d-flex w-100 justify-content-between align-items-start">
          <h5 class="mb-1 service-name"><span class="service-badge badge-c{{ (loop.index0 % 5) + 1 }}">{{ e.service[:1] }}</span>{{ e.service }}</h5>
          <div class="tile-actions">
            <button class="btn btn-sm btn-outline-secondary" type="button" onclick="viewEntry({{ loop.index0 }})">View</button>
            <a href="{{ url_for('edit', idx=loop.index0) }}" class="btn btn-sm btn-outline-primary">Edit</a>
            <form method="post" action="{{ url_for('delete', idx=loop.index0) }}" style="display:inline">
              <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
            </form>
          </div>
        </div>
        <div>
          <p class="mb-1">Username: {{ e.username }}</p>
          <div class="d-flex align-items-center">
            <label class="me-2 mb-0">Password:</label>
            <input id="pwd-{{ loop.index0 }}" type="text" class="form-control-plaintext me-2" value="{{ e.password }}" readonly style="max-width:300px">
            <button class="btn btn-sm btn-outline-secondary" type="button" onclick="togglePwd({{ loop.index0 }})">Hide/Show</button>
          </div>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">No entries yet.</div>
    {% endfor %}
  </div>

  <!-- Lightweight details modal -->
  <div id="detailModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); z-index:1050; width:90%; max-width:640px;">
    <div class="card shadow">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <h5 id="detailTitle" class="card-title">Entry</h5>
          <button class="btn-close" aria-label="Close" onclick="closeDetail()"></button>
        </div>
        <pre id="detailBody" style="white-space:pre-wrap; word-break:break-word;">{}</pre>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <script>
    const _entries = {{ entries|tojson }};
    function togglePwd(i) {
      const el = document.getElementById('pwd-' + i);
      if (!el) return;
      el.type = (el.type === 'password') ? 'text' : 'password';
    }
    function viewEntry(i) {
      const e = _entries[i];
      if (!e) return;
      document.getElementById('detailTitle').textContent = e.service || 'Entry';
      const body = `Service: ${e.service}\nUsername: ${e.username}\nPassword: ${e.password}\nNotes: ${e.notes || ''}`;
      document.getElementById('detailBody').textContent = body;
      document.getElementById('detailModal').style.display = 'block';
    }
    function closeDetail() {
      document.getElementById('detailModal').style.display = 'none';
    }
  </script>
{% endblock %}
